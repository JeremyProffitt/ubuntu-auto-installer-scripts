#cloud-config
autoinstall:
  version: 1

  # Suppress all interactive prompts for fully automated installation
  interactive-sections: []

  # Early commands run before installation (in live environment)
  early-commands:
    # Log installation start time
    - echo "=== Ubuntu Auto-Install Started: $(date) ===" | tee /run/install-start.log
    # Check SMART health on all disks and log results (non-blocking)
    - |
      echo "=== Disk Health Check ===" | tee /run/disk-health.log
      for disk in /dev/sd? /dev/nvme?n1; do
        if [ -e "$disk" ]; then
          echo "Checking $disk..." | tee -a /run/disk-health.log
          smartctl -H "$disk" 2>/dev/null | tee -a /run/disk-health.log || echo "SMART not supported on $disk" | tee -a /run/disk-health.log
        fi
      done
      echo "=== Health Check Complete ===" | tee -a /run/disk-health.log
    # Ensure network is available
    - |
      echo "Waiting for network..."
      for i in $(seq 1 30); do
        if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
          echo "Network available"
          break
        fi
        sleep 2
      done

  # Fully automated - use smallest SSD available
  # This avoids accidentally installing on large data/HDD drives
  storage:
    layout:
      name: lvm
      match:
        size: smallest
        ssd: true
        install-media: false

  # Locale and keyboard
  locale: ${LOCALE:-en_US.UTF-8}
  keyboard:
    layout: ${KEYBOARD_LAYOUT:-us}

  # Identity configuration (populated by setup script)
  identity:
    hostname: ${INSTALL_HOSTNAME:-ubuntu-server}
    username: ${INSTALL_USERNAME:-admin}
    # Password hash will be inserted by the USB creation script
    password: ${PASSWORD_HASH}

  # SSH configuration
  ssh:
    install-server: true
    allow-pw: true
    authorized-keys: []

  # Network - DHCP by default
  network:
    version: 2
    ethernets:
      id0:
        match:
          driver: "*"
        dhcp4: true
        dhcp6: true

  # Timezone
  timezone: ${TIMEZONE:-America/New_York}

  # Package configuration
  apt:
    primary:
      - arches: [default]
        uri: http://archive.ubuntu.com/ubuntu
    geoip: true

  # Packages to install during installation
  packages:
    # Essential firmware and drivers
    - linux-firmware
    - intel-microcode
    - amd64-microcode

    # Build tools for DKMS
    - build-essential
    - dkms
    - linux-headers-generic

    # Network tools
    - network-manager
    - wpasupplicant
    - wireless-tools
    - ethtool
    - net-tools

    # Storage and partitioning tools
    - nvme-cli
    - smartmontools
    - hdparm
    - mdadm
    - lvm2
    - parted
    - gdisk
    - ntfs-3g
    - exfat-fuse
    - exfatprogs

    # System utilities
    - openssh-server
    - curl
    - wget
    - git
    - htop
    - vim
    - tmux
    - unzip

    # Hardware monitoring
    - lm-sensors
    - i2c-tools
    - fancontrol

    # Power management
    - thermald
    - powertop

    # Audio (always install for compatibility)
    - alsa-utils
    - alsa-base

    # USB utilities
    - usbutils
    - pciutils

    # Firmware update daemon
    - fwupd

  # Late commands run in the installed system (chroot)
  late-commands:
    # Create directories for scripts
    - mkdir -p /target/opt/ubuntu-installer-scripts
    - mkdir -p /target/opt/ubuntu-installer

    # Copy all scripts (with error handling for missing files)
    - cp /cdrom/scripts/install-drivers.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - cp /cdrom/scripts/post-install.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - cp /cdrom/scripts/mount-drives.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - cp /cdrom/scripts/install-gui.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - cp /cdrom/scripts/configure-drives.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - cp /cdrom/scripts/install-optional-features.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - chmod +x /target/opt/ubuntu-installer-scripts/*.sh 2>/dev/null || true

    # Create symlinks in /opt for backward compatibility
    - ln -sf /opt/ubuntu-installer-scripts/install-drivers.sh /target/opt/install-drivers.sh 2>/dev/null || true
    - ln -sf /opt/ubuntu-installer-scripts/post-install.sh /target/opt/post-install.sh 2>/dev/null || true
    - ln -sf /opt/ubuntu-installer-scripts/mount-drives.sh /target/opt/mount-drives.sh 2>/dev/null || true
    - ln -sf /opt/ubuntu-installer-scripts/install-gui.sh /target/opt/install-gui.sh 2>/dev/null || true
    - ln -sf /opt/ubuntu-installer-scripts/configure-drives.sh /target/opt/configure-drives.sh 2>/dev/null || true
    - ln -sf /opt/ubuntu-installer-scripts/install-optional-features.sh /target/opt/install-optional-features.sh 2>/dev/null || true

    # Copy configuration
    - cp /cdrom/scripts/config.env /target/opt/ubuntu-installer/config.env 2>/dev/null || true

    # Create systemd service for first-boot setup (unattended mode)
    - |
      cat > /target/etc/systemd/system/first-boot-setup.service << 'EOF'
      [Unit]
      Description=First Boot Setup - Install Drivers and Configure System
      After=network-online.target
      Wants=network-online.target
      ConditionPathExists=/opt/ubuntu-installer-scripts/post-install.sh

      [Service]
      Type=oneshot
      ExecStart=/opt/ubuntu-installer-scripts/post-install.sh --unattended
      ExecStartPost=/bin/systemctl disable first-boot-setup.service
      RemainAfterExit=yes
      StandardInput=null
      StandardOutput=journal+console
      StandardError=journal+console
      TimeoutStartSec=1800

      [Install]
      WantedBy=multi-user.target
      EOF
    - curtin in-target --target=/target -- systemctl enable first-boot-setup.service

    # Enable SSH
    - curtin in-target --target=/target -- systemctl enable ssh

    # Prevent GRUB from probing/modifying other disks (protects USB boot drive)
    - echo "GRUB_DISABLE_OS_PROBER=true" >> /target/etc/default/grub
    - echo "GRUB_FORCE_PARTUUID=" >> /target/etc/default/grub

    # Update GRUB with the new settings
    - curtin in-target --target=/target -- update-grub

    # Update initramfs with NVMe support
    - curtin in-target --target=/target -- update-initramfs -u -k all
