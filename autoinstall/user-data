#cloud-config
autoinstall:
  version: 1

  # Suppress all interactive prompts for fully automated installation
  interactive-sections: []

  # Early commands run before installation (in live environment)
  # Complex logic externalized to early-setup.sh to avoid YAML block scalar parsing issues
  early-commands:
    - [/bin/bash, /cdrom/scripts/early-setup.sh]

  # Fully automated - use smallest SSD available
  # This avoids accidentally installing on large data/HDD drives
  storage:
    layout:
      name: lvm
      sizing-policy: all
      match:
        size: smallest
        ssd: true
        install-media: false

  # Locale and keyboard
  locale: ${LOCALE:-en_US.UTF-8}
  keyboard:
    layout: ${KEYBOARD_LAYOUT:-us}

  # Identity configuration (populated by setup script)
  identity:
    hostname: ${INSTALL_HOSTNAME:-ubuntu-server}
    username: ${INSTALL_USERNAME:-admin}
    # Password hash will be inserted by the USB creation script
    password: ${PASSWORD_HASH}

  # SSH configuration
  ssh:
    install-server: true
    allow-pw: true
    authorized-keys: []

  # Network - DHCP by default
  # NOTE: On Dell systems with iDRAC in "shared" NIC mode, the "en*" pattern
  # will also configure the management interface. Set iDRAC to "Dedicated" NIC
  # mode in BIOS if deploying on a network with a separate management VLAN.
  network:
    version: 2
    ethernets:
      id0:
        match:
          name: "en*"
        dhcp4: true
        dhcp6: true

  # Timezone
  timezone: ${TIMEZONE:-America/New_York}

  # Package configuration
  apt:
    primary:
      - arches: [default]
        uri: https://archive.ubuntu.com/ubuntu
    geoip: true

  # Packages to install during installation
  packages:
    # Essential firmware and drivers
    - linux-firmware
    - intel-microcode
    - amd64-microcode

    # Build tools for DKMS
    - build-essential
    - dkms
    - linux-headers-generic

    # Network tools
    - network-manager
    - wpasupplicant
    - wireless-tools
    - ethtool
    - net-tools

    # Storage and partitioning tools
    - nvme-cli
    - smartmontools
    - hdparm
    - mdadm
    - lvm2
    - parted
    - gdisk
    - ntfs-3g
    - exfatprogs

    # System utilities
    - openssh-server
    - curl
    - wget
    - git
    - htop
    - vim
    - tmux
    - unzip

    # Hardware monitoring
    - lm-sensors
    - i2c-tools
    - fancontrol

    # Power management (thermald installed conditionally by install-drivers.sh based on socket count)
    - powertop

    # IPMI, RAID, and NUMA packages installed conditionally by install-drivers.sh
    # based on detected hardware (Dell T7910, etc.)
    - sg3-utils

    # Audio (always install for compatibility)
    - alsa-utils

    # USB utilities
    - usbutils
    - pciutils

    # GPU driver detection
    - ubuntu-drivers-common

    # Firmware update daemon
    - fwupd

  # Late commands run in the installed system (chroot)
  late-commands:
    # Create directories for scripts
    - mkdir -p /target/opt/ubuntu-installer-scripts
    - mkdir -p /target/opt/ubuntu-installer

    # Copy all scripts (with error handling for missing files)
    - cp /cdrom/scripts/install-drivers.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - cp /cdrom/scripts/post-install.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - cp /cdrom/scripts/mount-drives.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - cp /cdrom/scripts/install-gui.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - cp /cdrom/scripts/configure-drives.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - cp /cdrom/scripts/install-optional-features.sh /target/opt/ubuntu-installer-scripts/ 2>/dev/null || true
    - chmod +x /target/opt/ubuntu-installer-scripts/*.sh 2>/dev/null || true

    # Create symlinks in /opt for backward compatibility
    - ln -sf /opt/ubuntu-installer-scripts/install-drivers.sh /target/opt/install-drivers.sh 2>/dev/null || true
    - ln -sf /opt/ubuntu-installer-scripts/post-install.sh /target/opt/post-install.sh 2>/dev/null || true
    - ln -sf /opt/ubuntu-installer-scripts/mount-drives.sh /target/opt/mount-drives.sh 2>/dev/null || true
    - ln -sf /opt/ubuntu-installer-scripts/install-gui.sh /target/opt/install-gui.sh 2>/dev/null || true
    - ln -sf /opt/ubuntu-installer-scripts/configure-drives.sh /target/opt/configure-drives.sh 2>/dev/null || true
    - ln -sf /opt/ubuntu-installer-scripts/install-optional-features.sh /target/opt/install-optional-features.sh 2>/dev/null || true

    # Copy configuration
    - cp /cdrom/scripts/config.env /target/opt/ubuntu-installer/config.env 2>/dev/null || true
    - chmod 600 /target/opt/ubuntu-installer/config.env 2>/dev/null || true
    - chown root:root /target/opt/ubuntu-installer/config.env 2>/dev/null || true

    # Blacklist nouveau before first boot (prevents conflict with NVIDIA proprietary driver)
    - |
      cat > /target/etc/modprobe.d/blacklist-nouveau.conf << 'EOF'
      blacklist nouveau
      options nouveau modeset=0
      EOF
    - sed -i 's/^[[:space:]]*//' /target/etc/modprobe.d/blacklist-nouveau.conf

    # Create systemd service for first-boot setup (unattended mode)
    - |
      cat > /target/etc/systemd/system/first-boot-setup.service << 'EOF'
      [Unit]
      Description=First Boot Setup - Install Drivers and Configure System
      After=network-online.target local-fs.target
      Wants=network-online.target
      RequiresMountsFor=/opt/ubuntu-installer-scripts
      ConditionPathExists=/opt/ubuntu-installer-scripts/post-install.sh
      ConditionPathExists=!/var/log/install-complete
      StartLimitBurst=3
      StartLimitIntervalSec=3600

      [Service]
      Type=oneshot
      ExecStart=/opt/ubuntu-installer-scripts/post-install.sh --unattended
      ExecStartPost=/bin/sh -c 'test -f /var/log/install-complete && systemctl disable first-boot-setup.service || true'
      RemainAfterExit=no
      StandardInput=null
      StandardOutput=journal+console
      StandardError=journal+console
      TimeoutStartSec=7200
      Restart=on-failure
      RestartSec=60

      [Install]
      WantedBy=multi-user.target
      EOF
    - sed -i 's/^[[:space:]]*//' /target/etc/systemd/system/first-boot-setup.service
    - curtin in-target --target=/target -- systemctl enable first-boot-setup.service

    # Enable SSH
    - curtin in-target --target=/target -- systemctl enable ssh

    # Prevent GRUB from probing/modifying other disks (protects USB boot drive)
    - grep -q "^GRUB_DISABLE_OS_PROBER=true" /target/etc/default/grub 2>/dev/null || echo "GRUB_DISABLE_OS_PROBER=true" >> /target/etc/default/grub

    # Set GRUB recordfail timeout so headless/SOL systems don't wait forever after a failed boot
    - grep -q "^GRUB_RECORDFAIL_TIMEOUT=" /target/etc/default/grub 2>/dev/null || echo "GRUB_RECORDFAIL_TIMEOUT=30" >> /target/etc/default/grub

    # Update GRUB with the new settings
    - curtin in-target --target=/target -- update-grub

    # Update initramfs with NVMe support
    - curtin in-target --target=/target -- update-initramfs -u -k all
